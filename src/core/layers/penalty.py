import torch
import torch.nn as nn
import torch.nn.functional as F


class ArcMarginPenaltyLogists(nn.Module):
    def __init__(
        self,
        in_features: int,
        num_classes: int,
        margin: float = 0.5,
        logist_scale: int = 64,
        **kwargs,
    ):
        super(ArcMarginPenaltyLogists, self).__init__()
        self.weights = torch.nn.Parameter(
            data=torch.randn((in_features, num_classes), dtype=torch.float),
            requires_grad=True,
        )
        self.num_classes = num_classes
        self.margin = torch.Tensor(margin, dtype=torch.float64)
        self.logist_scale = logist_scale

        self.cos_m = torch.cos(self.margin)
        self.sin_m = torch.sin(self.margin)
        self.th = torch.cos(torch.pi - self.margin)
        self.mm = torch.multiply(self.sin_m, self.margin)

    def forward(
        self,
        embedding_vectors: torch.Tensor,
        labels: torch.Tensor,
    ):
        normed_embedding_vectors = F.normalize(input=embedding_vectors, p=2.0, dim=1)
        normed_weights = F.normalize(input=self.weights, p=2.0, dim=0)

        cos_t = torch.multiply(normed_embedding_vectors, normed_weights)
        sin_t = torch.sqrt(1.0 - cos_t ** 2)

        cos_mt = torch.subtract(cos_t * self.cos_m, sin_t * self.sin_m)
        cos_mt = torch.where(cos_t > self.th, cos_mt, cos_t - self.mm)

        labels = labels.type(torch.int32)
        mask = F.one_hot(labels.type(torch.int32), num_classes=self.num_classes)

        logists = torch.wehre(mask == 1.0, cos_mt, cos_t)
        logists = torch.multiply(logists, self.logist_scale)

        return logists


if __name__ == "__main__":
    logists_layers = ArcMarginPenaltyLogists(
        num_classes=85742, margin=0.5, logist_scale=64
    )
    inputs = torch.Tensor(
        [
            [
                47615.63,
                44658.387,
                66148.64,
                31451.54,
                -123953.61,
                -158220.28,
                120102.08,
                -119881.625,
                -69289.4,
                -97282.27,
                56534.656,
                -93287.01,
                38482.996,
                -110206.81,
                110238.586,
                67900.47,
                57314.71,
                -123194.84,
                119841.586,
                25713.418,
                31504.947,
                140644.56,
                -150267.17,
                1390.1276,
                -173168.47,
                -10423.05,
                -61108.504,
                123825.3,
                -54693.414,
                38579.95,
                -106053.42,
                106947.87,
                -135552.83,
                49265.902,
                92520.516,
                -47707.316,
                -124840.64,
                153692.66,
                88592.555,
                40535.746,
                147931.94,
                129488.22,
                -16638.146,
                34004.953,
                -140848.89,
                112752.516,
                -64689.484,
                158381.0,
                149284.81,
                -128864.25,
                -71932.44,
                -68076.87,
                29453.705,
                -176451.33,
                46238.855,
                6951.0137,
                -94285.21,
                -71296.07,
                -128854.055,
                37538.67,
                62662.875,
                12011.357,
                -26832.68,
                -20065.223,
                -55738.504,
                76335.42,
                -45743.93,
                -116900.125,
                119165.9,
                -61276.938,
                102038.89,
                -3488.9954,
                91866.85,
                55126.96,
                -12667.689,
                -157898.25,
                -29714.611,
                -146406.3,
                116118.7,
                83683.24,
                -131883.0,
                144677.81,
                75948.086,
                29192.504,
                -114264.15,
                -64780.348,
                150727.84,
                -159392.67,
                -41177.508,
                -162359.03,
                -168053.34,
                -162071.02,
                -132051.9,
                -9611.55,
                82270.06,
                137336.73,
                7030.0874,
                176080.7,
                172789.16,
                70555.26,
                155806.61,
                130688.836,
                -170480.27,
                27844.502,
                26196.639,
                103623.66,
                -46594.07,
                100666.87,
                99083.85,
                -161011.77,
                -160525.98,
                114633.7,
                -92117.95,
                -125098.72,
                -161256.78,
                -39134.82,
                43866.07,
                30180.295,
                74259.48,
                34995.91,
                98990.02,
                96890.17,
                20009.248,
                -167420.55,
                -3228.8677,
                -104746.96,
                3934.6782,
                16930.816,
                87851.945,
                -47196.125,
                101668.56,
                97143.12,
                -15021.27,
                126701.195,
                -35730.09,
                -146125.62,
                -121771.31,
                25366.146,
                123532.64,
                -124732.17,
                17131.72,
                13822.791,
                76299.79,
                147646.77,
                -158239.66,
                -4563.636,
                147457.44,
                102576.88,
                25861.086,
                129226.836,
                -122330.43,
                33295.457,
                57653.836,
                -144361.88,
                84483.42,
                -130482.65,
                74685.3,
                27096.232,
                171048.36,
                -27431.836,
                -41941.055,
                26449.166,
                28665.467,
                25654.172,
                173246.05,
                -60696.273,
                19115.764,
                117633.75,
                -116714.66,
                -133448.56,
                -132750.95,
                51658.05,
                143179.4,
                -46466.58,
                -71908.54,
                162985.78,
                -109672.625,
                3579.5986,
                -32407.398,
                10984.662,
                158445.3,
                62987.094,
                40862.94,
                -67033.35,
                121972.71,
                -74967.31,
                8047.496,
                81589.06,
                50283.105,
                142703.38,
                46727.473,
                -84292.98,
                -45556.22,
                -43547.895,
                -76106.33,
                156197.9,
                -128776.02,
                -162371.2,
                -41455.78,
                104204.08,
                32650.69,
                87036.43,
                94972.58,
                -41939.734,
                -86391.26,
                63937.805,
                61932.453,
                -121757.61,
                96173.28,
                44208.035,
                107419.63,
                -161586.33,
                -11643.247,
                52382.93,
                -3796.706,
                -28535.555,
                -135454.08,
                -138464.08,
                2674.6455,
                92379.73,
                -95969.73,
                -16258.707,
                43535.57,
                -42271.63,
                -159983.2,
                -29099.195,
                -5434.6455,
                -133047.53,
                -132913.62,
                -89594.45,
                -173504.7,
                130675.56,
                173943.05,
                37158.53,
                -82064.7,
                57567.56,
                -12806.757,
                1444.0789,
                36466.02,
                -24273.479,
                -13447.762,
                23799.01,
                -15206.582,
                -133227.89,
                46447.496,
                73320.26,
                -21903.545,
                -36886.89,
                165437.69,
                77031.25,
                51204.617,
                43419.6,
                -169056.22,
                62307.29,
                75189.586,
                -176649.47,
                -168681.06,
                -134989.31,
                -12213.577,
                -120157.12,
                33764.973,
                76396.055,
                -106190.41,
                -46529.754,
                141034.28,
                -170807.25,
                33460.766,
                61202.336,
                166659.44,
                111771.11,
                -53463.03,
                -81597.71,
                -154541.6,
                99827.766,
                105987.5,
                177028.81,
                -2865.5403,
                117281.85,
                103641.41,
                -44089.71,
                14905.497,
                165441.9,
                50288.45,
                -123004.44,
                -71423.53,
                -155196.6,
                136633.1,
                -2342.9043,
                154746.78,
                172000.39,
                140228.61,
                159070.83,
                88486.67,
                -4091.1738,
                -162387.78,
                -88370.96,
                91000.04,
                -2421.3035,
                -73832.19,
                17763.94,
                -76503.86,
                161427.03,
                34624.453,
                150893.77,
                150929.66,
                -111356.24,
                34078.316,
                -114368.12,
                -67499.24,
                -58338.78,
                -47924.85,
                100531.57,
                104863.62,
                34941.08,
                7442.809,
                70626.875,
                -141084.64,
                136679.27,
                -115539.336,
                -27454.967,
                -122145.4,
                -90151.09,
                172721.75,
                134484.25,
                163473.22,
                136509.11,
                -161204.9,
                68526.7,
                175495.81,
                -131703.69,
                -134306.62,
                86959.91,
                -168897.23,
                -169123.8,
                -4828.935,
                175013.95,
                -8714.221,
                -34521.01,
                131208.6,
                125489.87,
                -91754.3,
                -129329.11,
                67009.48,
                -68960.34,
                6963.255,
                51707.812,
                32982.645,
                38273.03,
                -162834.19,
                142661.12,
                -3370.2578,
                -46464.684,
                85764.02,
                -31686.877,
                141309.5,
                111102.984,
                71071.79,
                109454.266,
                159887.62,
                -117273.22,
                49528.496,
                -74897.81,
                -94562.56,
                -95299.99,
                12530.526,
                -82919.06,
                -75054.9,
                63700.234,
                -112179.96,
                126512.92,
                6181.8125,
                -130386.5,
                42977.2,
                -39194.676,
                -81276.766,
                -76240.02,
                95405.67,
                46128.082,
                125709.11,
                83444.8,
                -120656.11,
                59754.75,
                89127.984,
                -157350.12,
                -108130.234,
                -84972.33,
                69354.59,
                44315.695,
                -56234.883,
                -93683.9,
                -95414.61,
                -99103.78,
                -26224.701,
                -100193.78,
                7091.4434,
                146726.58,
                -140099.33,
                77492.734,
                23076.96,
                -93753.26,
                -167193.34,
                -52110.004,
                -74725.99,
                166510.67,
                79906.72,
                -75462.016,
                105765.21,
                151704.8,
                -172830.69,
                59681.938,
                -124872.02,
                36708.43,
                147406.4,
                38212.07,
                -154943.62,
                -76340.086,
                -148588.47,
                -123872.516,
                58453.984,
                -51269.234,
                -149496.27,
                15235.798,
                -139994.78,
                39120.27,
                -150797.52,
                -43362.203,
                29382.082,
                -166682.94,
                107677.75,
                3689.502,
                -86725.55,
                48981.13,
                22948.773,
                99026.89,
                110060.9,
                -100112.06,
                54278.645,
                -17261.451,
                147135.72,
                55599.15,
                -111829.79,
                171471.89,
                78258.56,
                -136092.44,
                97514.73,
                80188.89,
                59096.176,
                41089.543,
                -85694.16,
                155432.08,
                -111525.31,
                -100695.22,
                113025.78,
                -36966.324,
                -46619.242,
                142053.39,
                129219.83,
                -24290.994,
                -61606.14,
                117172.4,
                -7808.6045,
                2305.6,
                -89991.0,
                -1202.0535,
                79556.52,
                -54237.695,
                2080.2246,
                -142319.3,
                86208.41,
                -145906.06,
                108723.27,
                -153573.8,
                -149930.7,
                148879.44,
                -129820.37,
                132637.34,
                162503.7,
                107337.72,
                -26355.605,
                -67486.984,
                -161342.34,
                155641.45,
                163487.36,
                -1449.3064,
                21060.762,
                88464.04,
                -169367.03,
                95431.875,
                156589.16,
                -88578.65,
                -115357.39,
                -166355.34,
                111307.16,
                89971.18,
                120459.42,
                138133.66,
                -53058.383,
                84151.19,
                62571.4,
                -100745.945,
                -64320.33,
                162830.23,
                -108003.555,
                -106398.03,
                -73009.0,
                100819.64,
                -150595.58,
                130445.055,
                11983.315,
                -54881.652,
                -61578.223,
                86652.945,
            ]
        ]
    )

    target_normed_embedding_vectors = torch.Tensor(
        [
            [
                0.02070199,
                0.01941626,
                0.02875964,
                0.01367428,
                -0.05389168,
                -0.0687899,
                0.05221714,
                -0.05212129,
                -0.03012516,
                -0.0422957,
                0.02457974,
                -0.04055867,
                0.01673137,
                -0.04791494,
                0.04792876,
                0.02952129,
                0.02491889,
                -0.05356179,
                0.05210388,
                0.0111795,
                0.0136975,
                0.06114845,
                -0.06533211,
                0.00060439,
                -0.07528897,
                -0.00453166,
                -0.02656833,
                0.05383589,
                -0.02377922,
                0.01677352,
                -0.04610916,
                0.04649804,
                -0.05893471,
                0.02141948,
                0.04022542,
                -0.02074185,
                -0.05427734,
                0.06682141,
                0.03851765,
                0.01762385,
                0.06431681,
                0.05629798,
                -0.00723382,
                0.01478443,
                -0.06123729,
                0.04902175,
                -0.02812524,
                0.06885978,
                0.064905,
                -0.05602669,
                -0.03127428,
                -0.02959798,
                0.01280568,
                -0.07671627,
                0.0201034,
                0.00302211,
                -0.04099266,
                -0.0309976,
                -0.05602226,
                0.0163208,
                0.02724412,
                0.00522221,
                -0.01166612,
                -0.00872382,
                -0.02423359,
                0.03318858,
                -0.01988822,
                -0.05082501,
                0.05181011,
                -0.02664156,
                0.04436375,
                -0.00151692,
                0.03994123,
                0.02396771,
                -0.00550757,
                -0.06864989,
                -0.01291911,
                -0.0636535,
                0.05048527,
                0.03638321,
                -0.05733917,
                0.062902,
                0.03302018,
                0.01269211,
                -0.04967896,
                -0.02816474,
                0.06553239,
                -0.06929962,
                -0.01790287,
                -0.07058932,
                -0.07306505,
                -0.0704641,
                -0.0574126,
                -0.00417884,
                0.0357688,
                0.0597103,
                0.00305649,
                0.07655513,
                0.07512406,
                0.03067552,
                0.0677405,
                0.05681998,
                -0.07412021,
                0.01210604,
                0.01138959,
                0.04505276,
                -0.02025784,
                0.04376723,
                0.04307898,
                -0.07000356,
                -0.06979236,
                0.04983963,
                -0.04005039,
                -0.05438954,
                -0.07011009,
                -0.01701476,
                0.01907178,
                0.01312158,
                0.03228601,
                0.01521528,
                0.04303819,
                0.04212523,
                0.00869948,
                -0.07278993,
                -0.00140382,
                -0.04554115,
                0.00171069,
                0.00736106,
                0.03819565,
                -0.0205196,
                0.04420274,
                0.0422352,
                -0.00653084,
                0.05508626,
                -0.01553448,
                -0.06353147,
                -0.05294288,
                0.01102852,
                0.05370865,
                -0.05423018,
                0.00744841,
                0.00600978,
                0.03317308,
                0.06419282,
                -0.06879833,
                -0.00198415,
                0.06411051,
                0.04459766,
                0.0112437,
                0.05618434,
                -0.05318597,
                0.01447596,
                0.02506633,
                -0.06276464,
                0.03673111,
                -0.05673033,
                0.03247115,
                0.01178071,
                0.0743672,
                -0.01192662,
                -0.01823484,
                0.01149938,
                0.01246297,
                0.01115374,
                0.0753227,
                -0.0263891,
                0.00831102,
                0.05114397,
                -0.05074438,
                -0.05801983,
                -0.05771653,
                0.02245952,
                0.06225054,
                -0.02020241,
                -0.03126389,
                0.07086181,
                -0.04768269,
                0.00155631,
                -0.01408986,
                0.00477583,
                0.06888773,
                0.02738509,
                0.0177661,
                -0.02914429,
                0.05303044,
                -0.03259376,
                0.00349883,
                0.03547272,
                0.02186174,
                0.06204357,
                0.02031584,
                -0.03664831,
                -0.01980661,
                -0.01893345,
                -0.03308897,
                0.06791063,
                -0.05598833,
                -0.07059461,
                -0.01802385,
                0.04530512,
                0.01419564,
                0.03784109,
                0.04129151,
                -0.01823426,
                -0.03756058,
                0.02779843,
                0.02692656,
                -0.05293692,
                0.04181354,
                0.01922046,
                0.04670315,
                -0.07025336,
                -0.00506217,
                0.02277468,
                -0.00165071,
                -0.01240649,
                -0.05889177,
                -0.06020044,
                0.00116286,
                0.04016421,
                -0.04172504,
                -0.00706885,
                0.01892809,
                -0.01837856,
                -0.06955637,
                -0.01265154,
                -0.00236284,
                -0.05784547,
                -0.05778725,
                -0.03895325,
                -0.07543515,
                0.0568142,
                0.07562573,
                0.01615552,
                -0.03567952,
                0.02502882,
                -0.00556803,
                0.00062785,
                0.01585444,
                -0.01055345,
                -0.00584672,
                0.01034717,
                -0.00661141,
                -0.05792389,
                0.02019412,
                0.03187767,
                -0.00952307,
                -0.01603742,
                0.07192784,
                0.0334911,
                0.02226238,
                0.01887767,
                -0.07350107,
                0.02708953,
                0.0326904,
                -0.07680242,
                -0.07333796,
                -0.05868971,
                -0.00531013,
                -0.05224107,
                0.0146801,
                0.03321494,
                -0.04616872,
                -0.02022988,
                0.06131789,
                -0.07426237,
                0.01454784,
                0.02660912,
                0.07245902,
                0.04859506,
                -0.02324428,
                -0.03547648,
                -0.06719051,
                0.04340241,
                0.0460805,
                0.07696734,
                -0.00124586,
                0.05099098,
                0.04506048,
                -0.01916901,
                0.00648051,
                0.07192967,
                0.02186406,
                -0.053479,
                -0.03105302,
                -0.06747528,
                0.05940438,
                -0.00101863,
                0.06727972,
                0.07478112,
                0.06096761,
                0.06915969,
                0.03847161,
                -0.00177873,
                -0.07060182,
                -0.03842131,
                0.03956436,
                -0.00105272,
                -0.03210024,
                0.00772328,
                -0.03326181,
                0.07018411,
                0.01505378,
                0.06560453,
                0.06562013,
                -0.04841468,
                0.01481633,
                -0.04972417,
                -0.02934685,
                -0.02536413,
                -0.02083643,
                0.04370841,
                0.04559186,
                0.01519144,
                0.00323593,
                0.03070666,
                -0.06133979,
                0.05942445,
                -0.05023338,
                -0.01193668,
                -0.05310552,
                -0.03919526,
                0.07509475,
                0.05847012,
                0.07107374,
                0.05935047,
                -0.07008754,
                0.02979356,
                0.07630084,
                -0.0572612,
                -0.05839289,
                0.03780782,
                -0.07343195,
                -0.07353046,
                -0.00209949,
                0.07609133,
                -0.00378871,
                -0.0150088,
                0.05704595,
                0.0545596,
                -0.03989229,
                -0.0562288,
                0.02913391,
                -0.02998209,
                0.00302743,
                0.02248116,
                0.01433996,
                0.01664008,
                -0.0707959,
                0.0620252,
                -0.0014653,
                -0.02020159,
                0.03728788,
                -0.0137766,
                0.06143755,
                0.04830458,
                0.03090009,
                0.04758776,
                0.06951482,
                -0.05098723,
                0.02153365,
                -0.03256354,
                -0.04111325,
                -0.04143386,
                0.00544793,
                -0.03605097,
                -0.03263184,
                0.02769514,
                -0.04877282,
                0.0550044,
                0.00268768,
                -0.05668852,
                0.01868532,
                -0.01704079,
                -0.03533694,
                -0.0331471,
                0.04147981,
                0.02005524,
                0.05465492,
                0.03627954,
                -0.05245801,
                0.02597975,
                0.03875044,
                -0.06841158,
                -0.0470121,
                -0.03694367,
                0.0301535,
                0.01926727,
                -0.02444941,
                -0.04073123,
                -0.04148369,
                -0.04308765,
                -0.01140179,
                -0.04356155,
                0.00308317,
                0.06379275,
                -0.0609114,
                0.03369175,
                0.01003324,
                -0.04076138,
                -0.07269115,
                -0.02265602,
                -0.03248884,
                0.07239434,
                0.03474128,
                -0.03280884,
                0.04598385,
                0.06595714,
                -0.07514211,
                0.02594809,
                -0.05429098,
                0.01595983,
                0.06408832,
                0.01661357,
                -0.0673653,
                -0.0331906,
                -0.06460225,
                -0.05385642,
                0.02541421,
                -0.02229048,
                -0.06499694,
                0.00662411,
                -0.06086595,
                0.01700843,
                -0.06556268,
                -0.01885271,
                0.01277454,
                -0.07246923,
                0.04681538,
                0.0016041,
                -0.03770592,
                0.02129567,
                0.00997751,
                0.04305422,
                0.0478515,
                -0.04352602,
                0.02359889,
                -0.00750481,
                0.06397063,
                0.02417301,
                -0.04862057,
                0.07455134,
                0.03402471,
                -0.05916931,
                0.04239677,
                0.03486396,
                0.02569342,
                0.01786462,
                -0.0372575,
                0.06757767,
                -0.04848819,
                -0.04377956,
                0.04914055,
                -0.01607196,
                -0.02026879,
                0.06176097,
                0.05618129,
                -0.01056107,
                -0.02678468,
                0.05094339,
                -0.00339497,
                0.00100241,
                -0.03912565,
                -0.00052262,
                0.03458903,
                -0.02358108,
                0.00090443,
                -0.06187658,
                0.03748108,
                -0.06343601,
                0.04726994,
                -0.06676973,
                -0.06518582,
                0.06472875,
                -0.05644239,
                0.05766713,
                0.07065222,
                0.04666754,
                -0.01145871,
                -0.02934152,
                -0.07014729,
                0.0676687,
                0.07107989,
                -0.00063012,
                0.00915665,
                0.03846177,
                -0.0736362,
                0.0414912,
                0.06808073,
                -0.0385116,
                -0.05015428,
                -0.07232681,
                0.04839334,
                0.03911704,
                0.0523725,
                0.06005678,
                -0.02306835,
                0.03658666,
                0.02720435,
                -0.04380161,
                -0.02796474,
                0.07079419,
                -0.04695703,
                -0.04625899,
                -0.03174234,
                0.04383365,
                -0.06547489,
                0.05671398,
                0.00521002,
                -0.02386106,
                -0.02677255,
                0.03767436,
            ]
        ]
    )
